<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Einzelpersonen · settlement index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- GitHub Pages Projektpfad automatisch setzen -->
  <script>
    (function () {
      const isGitHubPages = location.hostname.endsWith("github.io");
      const basePath = isGitHubPages ? "/settlementindex/" : "/";
      const base = document.createElement("base");
      base.href = basePath;
      document.head.prepend(base);
    })();
  </script>

  <!-- global (shared) -->
  <link rel="stylesheet" href="shared/site.css">

  <style>
    :root{ --bg:#000; --fg:#fff; --muted:#bbb; --line:#333; }
    *{ box-sizing:border-box; }

    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:14px; line-height:1.4;
    }

    a{ color:var(--fg); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{ padding:14px 20px 80px; }

    h1{
      font-size:15px; font-weight:normal; margin:0 0 10px;
      text-transform:uppercase; letter-spacing:.04em;
    }

    .controls{
      display:flex; gap:14px; flex-wrap:wrap;
      margin:0 0 10px; color:var(--muted); font-size:13px;
    }
    .controls button{
      font:inherit; font-size:13px; color:var(--muted);
      background:transparent; border:0; padding:0; cursor:pointer;
    }
    .controls button:hover{ text-decoration:underline; }
    .controls button[aria-pressed="true"]{ color:var(--fg); text-decoration:underline; }

    .jump{
      display:flex; flex-wrap:wrap; gap:10px 14px;
      margin:0 0 18px; font-size:13px; color:var(--muted);
    }
    .jump a{ color:var(--muted); }
    .jump a:hover{ color:var(--fg); text-decoration:underline; }
    .jump a[aria-disabled="true"]{ opacity:.35; pointer-events:none; text-decoration:none; }

    .portrait-grid{ display:grid; gap:18px; }

    .group{ border-top:1px solid var(--line); padding-top:14px; }

    .group-title{
      margin:0 0 14px; font-size:13px; font-weight:normal;
      color:var(--muted); text-transform:uppercase; letter-spacing:.06em;
    }

    .group-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
      gap:18px;
    }
    @media (min-width:1100px){ .group-grid{ grid-template-columns:repeat(5, 1fr); } }
    @media (min-width:900px) and (max-width:1099px){ .group-grid{ grid-template-columns:repeat(4, 1fr); } }
    @media (min-width:680px) and (max-width:899px){ .group-grid{ grid-template-columns:repeat(3, 1fr); } }
    @media (max-width:679px){ .group-grid{ grid-template-columns:repeat(2, 1fr); } }

    figure{ margin:0; }

    img{
      width:100%; height:200px; display:block;
      object-fit:cover; object-position:50% 20%;
      filter:grayscale(100%) contrast(1.05);
      border:1px solid var(--line);
    }

    figcaption{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35; }
    figcaption b{ display:block; font-weight:normal; color:var(--fg); }
    figcaption span{ display:block; }

    footer{ margin-top:60px; font-size:13px; color:var(--muted); }
  </style>
</head>

<body>
<div id="nav-placeholder"></div>

<div class="wrap">

  <script src="../shared/init.js" defer></script>

  <h1>EINZELPERSONEN</h1>

  <div class="controls" role="group" aria-label="Sortierung">
    <span>sortierung:</span>
    <button id="sort-surname" type="button" aria-pressed="true">nachname</button>
    <button id="sort-role" type="button" aria-pressed="false">rolle</button>
  </div>

  <div class="jump" id="jump-az" aria-label="A bis Z"></div>
  <div class="jump" id="jump-roles" aria-label="Rollen" style="display:none"></div>

  <section class="portrait-grid" id="grid"></section>

  <footer>
    Archivische Porträts. Schwarzweiß. Umschaltbar: Nachname / Rolle.
  </footer>

</div>


<script src="people/data.js"></script>

<script>
  const grid = document.getElementById("grid");

  const jumpAZ = document.getElementById("jump-az");
  const jumpRoles = document.getElementById("jump-roles");

  const btnSurname = document.getElementById("sort-surname");
  const btnRole = document.getElementById("sort-role");

  function slugify(s){
    return (s||"")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "");
  }

  function cleanNameForSorting(name){
    return String(name || "")
      .replace(/\s*\([^)]*\)\s*/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function surnameOf(name){
    const n = cleanNameForSorting(name);
    const parts = n.split(" ").filter(Boolean);
    return parts.length ? parts[parts.length - 1] : "";
  }

  function groupKeyBySurname(name){
    const s = surnameOf(name)
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .trim();
    if(!s) return "#";
    const ch = s[0].toUpperCase();
    return /[A-Z]/.test(ch) ? ch : "#";
  }

  function roleKey(p){
    return (p.role || "Unbekannt").trim();
  }

  function setPressed(mode){
    const isSurname = mode === "surname";
    btnSurname.setAttribute("aria-pressed", String(isSurname));
    btnRole.setAttribute("aria-pressed", String(!isSurname));
    jumpAZ.style.display = isSurname ? "" : "none";
    jumpRoles.style.display = isSurname ? "none" : "";
  }

  function smoothJump(container, selector){
    container.querySelectorAll(selector).forEach(a => {
      a.addEventListener("click", (e) => {
        e.preventDefault();
        const id = a.getAttribute("href").slice(1);
        const el = document.getElementById(id);
        if(!el) return;

        const nav = document.getElementById("topnav");
        const navH = nav ? nav.getBoundingClientRect().height : 0;

        const y = el.getBoundingClientRect().top + window.scrollY - navH - 12;
        window.scrollTo({ top: y, behavior: "smooth" });
      });
    });
  }

  function buildAZ(presentKeys){
    jumpAZ.innerHTML = "";
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const frag = document.createDocumentFragment();

    letters.forEach(L => {
      const link = document.createElement("a");
      link.textContent = L;
      if(presentKeys.has(L)){
        link.href = `#group-${L}`;
      } else {
        link.href = "#";
        link.setAttribute("aria-disabled", "true");
      }
      frag.appendChild(link);
    });

    if(presentKeys.has("#")){
      const link = document.createElement("a");
      link.textContent = "#";
      link.href = "#group-hash";
      frag.appendChild(link);
    }

    jumpAZ.appendChild(frag);
    smoothJump(jumpAZ, 'a[href^="#group-"]');
  }

  function buildRoleJump(presentRoles){
    jumpRoles.innerHTML = "";
    const roles = [...presentRoles].sort((a,b) => a.localeCompare(b, "de"));
    const frag = document.createDocumentFragment();

    roles.forEach(r => {
      const link = document.createElement("a");
      link.textContent = r.toLowerCase();
      link.href = `#role-${slugify(r)}`;
      frag.appendChild(link);
    });

    jumpRoles.appendChild(frag);
    smoothJump(jumpRoles, 'a[href^="#role-"]');
  }

  function resolvePeopleImagePath(p){
    const raw = String(p.image || "");
    if (!raw) return raw;
    if (/^(https?:)?\/\//.test(raw)) return raw;
    if (raw.startsWith("/")) return raw;

    // falls data.js noch "images/..." nutzt
    if (raw.startsWith("images/")) return "people/" + raw;

    return raw;
  }

  function renderGroups(groups, keys, sectionIdFn, titleFn){
    grid.innerHTML = "";
    const frag = document.createDocumentFragment();

    keys.forEach(k => {
      const section = document.createElement("section");
      section.className = "group";
      section.id = sectionIdFn(k);

      const title = document.createElement("h2");
      title.className = "group-title";
      title.textContent = titleFn(k);
      section.appendChild(title);

      const inner = document.createElement("div");
      inner.className = "group-grid";

      groups.get(k).forEach(p => {
        const fig = document.createElement("figure");
        fig.id = p.slug ? String(p.slug) : slugify(cleanNameForSorting(p.name));

        const imgSrc = resolvePeopleImagePath(p);

        fig.innerHTML = `
          ${p.wiki ? `
            <a href="${p.wiki}" target="_blank" rel="noopener">
              <img loading="lazy" src="${imgSrc}" alt="${p.name}">
            </a>
          ` : `
            <img loading="lazy" src="${imgSrc}" alt="${p.name}">
          `}

          <figcaption>
            <b>${p.name}</b>
            <span>${p.life || ""}</span>
            ${p.role ? `<span>${p.role}</span>` : ""}
            ${p.knownFor ? `<span>${p.knownFor}</span>` : ""}
          </figcaption>
        `;

        inner.appendChild(fig);
      });

      section.appendChild(inner);
      frag.appendChild(section);
    });

    grid.appendChild(frag);
  }

  function renderBySurname(list){
    const groups = new Map();
    list.forEach(p => {
      const k = groupKeyBySurname(p.name);
      if(!groups.has(k)) groups.set(k, []);
      groups.get(k).push(p);
    });

    const keys = [...groups.keys()].sort((a,b) => {
      if(a === "#") return 1;
      if(b === "#") return -1;
      return a.localeCompare(b);
    });

    keys.forEach(k => {
      groups.get(k).sort((a,b) => {
        const sa = surnameOf(a.name).localeCompare(surnameOf(b.name), "de");
        if(sa !== 0) return sa;
        return cleanNameForSorting(a.name).localeCompare(cleanNameForSorting(b.name), "de");
      });
    });

    buildAZ(new Set(keys));
    renderGroups(groups, keys, (k) => (k === "#") ? "group-hash" : `group-${k}`, (k) => k);
  }

  function renderByRole(list){
    const groups = new Map();
    list.forEach(p => {
      const k = roleKey(p);
      if(!groups.has(k)) groups.set(k, []);
      groups.get(k).push(p);
    });

    const keys = [...groups.keys()].sort((a,b) => a.localeCompare(b, "de"));

    keys.forEach(k => {
      groups.get(k).sort((a,b) => {
        const sa = surnameOf(a.name).localeCompare(surnameOf(b.name), "de");
        if(sa !== 0) return sa;
        return cleanNameForSorting(a.name).localeCompare(cleanNameForSorting(b.name), "de");
      });
    });

    buildRoleJump(new Set(keys));
    renderGroups(groups, keys, (k) => `role-${slugify(k)}`, (k) => k);
  }

  function render(mode){
    localStorage.setItem("peopleSortMode", mode);
    setPressed(mode);

    const list = Array.isArray(people) ? [...people] : [];
    if(mode === "role") renderByRole(list);
    else renderBySurname(list);
  }

  const saved = localStorage.getItem("peopleSortMode");
  const initialMode = (saved === "role" || saved === "surname") ? saved : "surname";

  btnSurname.addEventListener("click", () => render("surname"));
  btnRole.addEventListener("click", () => render("role"));

  render(initialMode);
</script>
<script src="shared/init.js" defer></script>

</body>
</html>

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Filme · settlement index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- global (shared) -->
  <link rel="stylesheet" href="../shared/site.css">

  <style>
    :root{ --bg:#000; --fg:#fff; --muted:#bbb; --line:#333; }
    *{ box-sizing:border-box; }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:14px; line-height:1.4;
    }
    a{ color:var(--fg); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{ padding:14px 20px 80px; }

    h1{
      font-size:15px; font-weight:normal; margin:0 0 10px;
      text-transform:uppercase; letter-spacing:.04em;
    }

    .controls{
      display:flex; gap:14px; flex-wrap:wrap;
      margin:0 0 10px; color:var(--muted); font-size:13px;
    }
    .controls button{
      font:inherit; font-size:13px; color:var(--muted);
      background:transparent; border:0; padding:0; cursor:pointer;
    }
    .controls button:hover{ text-decoration:underline; }
    .controls button[aria-pressed="true"]{ color:var(--fg); text-decoration:underline; }

    .az{
      display:flex; flex-wrap:wrap; gap:10px 14px;
      margin:0 0 18px; font-size:13px; color:var(--muted);
    }
    .az a{ color:var(--muted); }
    .az a:hover{ color:var(--fg); text-decoration:underline; }
    .az a[aria-disabled="true"]{ opacity:.35; pointer-events:none; text-decoration:none; }

    .portrait-grid{ display:grid; gap:18px; }

    .group{ border-top:1px solid var(--line); padding-top:14px; }
    .group-title{
      margin:0 0 14px; font-size:13px; font-weight:normal;
      color:var(--muted); text-transform:uppercase; letter-spacing:.06em;
    }

    .group-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
      gap:18px;
    }
    @media (min-width:1100px){ .group-grid{ grid-template-columns:repeat(5, 1fr); } }
    @media (min-width:900px) and (max-width:1099px){ .group-grid{ grid-template-columns:repeat(4, 1fr); } }
    @media (min-width:680px) and (max-width:899px){ .group-grid{ grid-template-columns:repeat(3, 1fr); } }
    @media (max-width:679px){ .group-grid{ grid-template-columns:repeat(2, 1fr); } }

    figure{ margin:0; }

    img{
      width:100%; height:200px; display:block;
      object-fit:cover; object-position:50% 20%;
      filter:grayscale(100%) contrast(1.05);
      border:1px solid var(--line);
    }

    figcaption{
      margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35;
    }
    figcaption b{ display:block; font-weight:normal; color:var(--fg); }
    figcaption span{ display:block; }

    footer{ margin-top:60px; font-size:13px; color:var(--muted); }
  </style>
</head>

<body>
<div id="nav-placeholder"></div>

<div class="wrap">

  <script src="../shared/init.js" defer></script>


  <h1>FILME & DOKUMENTATIONEN</h1>

  <div class="controls" role="group" aria-label="Sortierung">
    <span>sortierung:</span>
    <button id="sort-alpha" type="button" aria-pressed="true">alphabetisch</button>
    <button id="sort-chrono" type="button" aria-pressed="false">chronologisch</button>
  </div>

  <div class="az" id="az" aria-label="A bis Z"></div>

  <section class="portrait-grid" id="grid"></section>

  <footer>
    Archivische Porträts. Schwarzweiß. Sortier- und Sprungnavigation.
  </footer>

</div>

<!-- Daten liegen im gleichen Ordner -->
<script src="./data.js"></script>

<script>
  const grid = document.getElementById("grid");
  const az = document.getElementById("az");
  const btnAlpha = document.getElementById("sort-alpha");
  const btnChrono = document.getElementById("sort-chrono");

  function normalize(s){
    return (s || "")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  // movie "life" wird hier als Jahr genutzt (wie in deinem Code)
  function yearFromLife(life){
    const m = String(life || "").match(/(\d{4})/);
    return m ? parseInt(m[1], 10) : Number.POSITIVE_INFINITY;
  }

  function groupKeyFromName(name){
    const n = normalize(name);
    if(!n) return "#";
    const ch = n[0].toUpperCase();
    return /[A-Z]/.test(ch) ? ch : "#";
  }

  function setPressed(mode){
    const isAlpha = mode === "alpha";
    btnAlpha.setAttribute("aria-pressed", String(isAlpha));
    btnChrono.setAttribute("aria-pressed", String(!isAlpha));
  }

  function buildAZ(presentKeys){
    az.innerHTML = "";
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const frag = document.createDocumentFragment();

    letters.forEach(L => {
      const link = document.createElement("a");
      link.textContent = L;

      if(presentKeys.has(L)){
        link.href = `#group-${L}`;
      } else {
        link.href = "#";
        link.setAttribute("aria-disabled", "true");
      }
      frag.appendChild(link);
    });

    if(presentKeys.has("#")){
      const link = document.createElement("a");
      link.textContent = "#";
      link.href = "#group-hash";
      frag.appendChild(link);
    }

    az.appendChild(frag);

    az.querySelectorAll('a[href^="#group-"]').forEach(a => {
      a.addEventListener("click", (e) => {
        e.preventDefault();
        const id = a.getAttribute("href").slice(1);
        const el = document.getElementById(id);
        if(!el) return;

        const nav = document.getElementById("topnav");
        const navH = nav ? nav.getBoundingClientRect().height : 0;

        const y = el.getBoundingClientRect().top + window.scrollY - navH - 12;
        window.scrollTo({ top: y, behavior: "smooth" });
      });
    });
  }

  function resolveMovieImagePath(p){
    const raw = String(p.image || "");
    if (!raw) return raw;
    if (/^(https?:)?\/\//.test(raw)) return raw;
    if (raw.startsWith("/")) return raw;

    // data.js nutzt typischerweise "images/..."
    if (raw.startsWith("images/")) return raw;

    return raw;
  }

  function renderGrouped(list){
    grid.innerHTML = "";

    const groups = new Map();
    list.forEach(item => {
      const k = groupKeyFromName(item.name);
      if(!groups.has(k)) groups.set(k, []);
      groups.get(k).push(item);
    });

    const keys = [...groups.keys()].sort((a,b) => {
      if(a === "#") return 1;
      if(b === "#") return -1;
      return a.localeCompare(b);
    });

    buildAZ(new Set(keys));

    const frag = document.createDocumentFragment();

    keys.forEach(k => {
      const section = document.createElement("section");
      section.className = "group";
      section.id = (k === "#") ? "group-hash" : `group-${k}`;

      const title = document.createElement("h2");
      title.className = "group-title";
      title.textContent = k;
      section.appendChild(title);

      const inner = document.createElement("div");
      inner.className = "group-grid";

      groups.get(k).forEach(p => {
        const fig = document.createElement("figure");

        const authorLine = (p.authorSlug && p.authorName)
          ? `<a href="../people/index.html#${p.authorSlug}">${p.authorName}</a>`
          : (p.authorName || "");

        const imgSrc = resolveMovieImagePath(p);

        fig.innerHTML = `
          ${p.wiki ? `
            <a href="${p.wiki}" target="_blank" rel="noopener">
              <img loading="lazy" src="${imgSrc}" alt="${p.name}">
            </a>
          ` : `
            <img loading="lazy" src="${imgSrc}" alt="${p.name}">
          `}

          <figcaption>
            <b>${p.name}${p.life ? ` (${p.life})` : ""}</b>

            ${p.book ? `
              <span>
                nach <i>${
                  p.bookWiki
                    ? `<a href="${p.bookWiki}" target="_blank" rel="noopener">${p.book}</a>`
                    : p.book
                }</i>${p.bookYear ? ` (${p.bookYear})` : ""}
              </span>
            ` : ""}

            ${authorLine ? `<span>${authorLine}</span>` : ""}
          </figcaption>
        `;

        inner.appendChild(fig);
      });

      section.appendChild(inner);
      frag.appendChild(section);
    });

    grid.appendChild(frag);
  }

  function sortList(mode){
    // data.js: const people = [...] (bei dir heißt die Movie-Liste "people")
    const list = [...(Array.isArray(people) ? people : [])];

    if(mode === "chrono"){
      list.sort((a,b) => {
        const ya = yearFromLife(a.life);
        const yb = yearFromLife(b.life);
        if(ya !== yb) return ya - yb;
        return normalize(a.name).localeCompare(normalize(b.name), "de");
      });
    } else {
      list.sort((a,b) => normalize(a.name).localeCompare(normalize(b.name), "de"));
    }

    return list;
  }

  function sortAndRender(mode){
    localStorage.setItem("moviesSortMode", mode);
    setPressed(mode);

    const list = sortList(mode);

    if(mode === "chrono"){
      const byLetter = new Map();
      list.forEach(p => {
        const k = groupKeyFromName(p.name);
        if(!byLetter.has(k)) byLetter.set(k, []);
        byLetter.get(k).push(p);
      });

      const merged = [];
      const keys = [...byLetter.keys()].sort((a,b)=> {
        if(a === "#") return 1;
        if(b === "#") return -1;
        return a.localeCompare(b);
      });

      keys.forEach(k => {
        byLetter.get(k).sort((a,b) => {
          const ya = yearFromLife(a.life);
          const yb = yearFromLife(b.life);
          if(ya !== yb) return ya - yb;
          return normalize(a.name).localeCompare(normalize(b.name), "de");
        });
        merged.push(...byLetter.get(k));
      });

      renderGrouped(merged);
      return;
    }

    renderGrouped(list);
  }

  const saved = localStorage.getItem("moviesSortMode");
  const initialMode = (saved === "chrono" || saved === "alpha") ? saved : "alpha";

  btnAlpha.addEventListener("click", () => sortAndRender("alpha"));
  btnChrono.addEventListener("click", () => sortAndRender("chrono"));

  sortAndRender(initialMode);
</script>
<script src="shared/init.js" defer></script>

</body>
</html>
